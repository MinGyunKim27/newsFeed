<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ í˜ì´ì§€</title>
    <style>

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f9fafb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 190px;
            height: 100vh;
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            transition: box-shadow 0.3s ease;
            z-index: 100;
        }

        .sidebar:hover {
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.08);
        }

        .sidebar h1 {
            font-size: 24px;
            color: #007aff;
            margin-bottom: 40px;
            margin-left: 24px;
            margin-top: 24px;
            transition: color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .sidebar h1:hover {
            color: #0056b3;
            transform: scale(1.05);
        }

        .menu-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            align-items: center;
            margin-top: -32px;
        }

        .sidebar .menu-item {
            width: 120px;
            padding: 16px 24px;
            color: #374151;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar .menu-item:hover {
            background-color: #f3f4f6;
            transform: translateX(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar .menu-item:hover::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background-color: #007aff;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { height: 0; }
            to { height: 100%; }
        }

        .sidebar .menu-item svg {
            margin-right: 8px;
            stroke: #6b7280;
            fill: none;
            transition: stroke 0.3s ease, transform 0.2s ease;
        }

        .sidebar .menu-item:hover svg {
            stroke: #007aff;
            transform: rotate(2deg) scale(1.05);
        }

        .profile-card {
            background: white;
            margin-left: 220px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 650px;
            width: 100%;
            text-align: left;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #007aff, transparent);
            transition: left 0.6s ease;
        }

        .profile-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            background-color: #fefefe;
        }

        .profile-card:hover::before {
            left: 100%;
        }

        .profile-wrapper {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .name-wrapper {
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            flex: 1;
        }

        .profile-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.4s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .userName {
            margin: 0;
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 600;
            color: #1f2937;
            transition: color 0.3s ease;
        }

        .profile-card:hover .userName {
            color: #007aff;
        }

        .user-handle {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 12px;
            transition: color 0.3s ease;
        }

        .profile-card:hover .user-handle {
            color: #374151;
        }

        .user-bio {
            color: #374151;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .profile-card:hover .user-bio {
            color: #1f2937;
        }

        .button-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
        }

        .follow-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 48%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .follow-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
        }

        .follow-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .follow-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .message-btn {
            padding: 12px 24px;
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 48%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .message-btn:hover {
            background: #f8fafc;
            border-color: #007aff;
            color: #007aff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
        }

        .text-title-container {
            display: flex;
            flex-direction: row;
            gap: 30px;
            text-align: center;
            font-size: 14px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
        }

        .stat-item:hover {
            background-color: #f3f4f6;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .stat-item:hover .stat-number {
            color: #007aff;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .stat-item:hover .stat-label {
            color: #374151;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
        }

        a:hover {
            text-decoration: none;
            color: #007aff;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #007aff;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .profile-card {
                margin-left: 0;
                margin: 20px;
                padding: 24px;
            }

            .sidebar {
                display: none;
            }

            .profile-wrapper {
                flex-direction: column;
                text-align: center;
            }

            .button-container {
                flex-direction: column;
                gap: 12px;
            }

            .follow-btn, .message-btn {
                width: 100%;
            }
        }

        .edit-profile-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #22b685, #129c71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .edit-profile-btn:hover {
            background: linear-gradient(135deg, #12956c, #0f7a5c);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(38, 177, 131, 0.4);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* ê¸°ì¡´ .modal-content ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px; /* ì´ ì¤„ ì¶”ê°€ */
        }

        /* ìƒˆë¡œìš´ í´ë˜ìŠ¤ ì¶”ê°€ */
        .create-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .cancel-btn, .save-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .cancel-btn {
            background: #e5e7eb;
            color: #374151;
        }

        .save-btn {
            background: #3b82f6;
            color: white;
        }

        .menu-btn:hover {
            background: #f3f4f6 !important;
        }

        .menu-dropdown {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box; /* ì´ ì¤„ë§Œ ì¶”ê°€ */
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-button.cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-button.submit {
            background: #3b82f6;
            color: white;
        }

        .modal-button:hover {
            opacity: 0.9;
        }

        /* ì™¼ìª½ í•˜ë‹¨ í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ */
        .hamburger-menu {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .hamburger-menu:hover {
            background: #f9fafb;
        }

        /* ë©”ë‰´ ì˜µì…˜ íŒ¨ë„ */
        .menu-options {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 8px;
            min-width: 180px;
            display: none;
            z-index: 1001;
        }

        .menu-item-option {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .menu-item-option:hover {
            background: #f3f4f6;
        }

        .menu-item-option.has-submenu::after {
            content: 'â€º';
            font-size: 16px;
            color: #6b7280;
        }

        /* ì„œë¸Œë©”ë‰´ */
        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            min-width: 120px;
            display: none;
            margin-left: 8px;
        }

        .submenu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .submenu-item:hover {
            background: #f3f4f6;
        }

        .logout-item {
            color: #ef4444;
            border-top: 1px solid #f3f4f6;
            margin-top: 4px;
            padding-top: 12px;
        }

        /* ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì‘ì„± í˜ì´ì§€ */
        .write-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 400px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .write-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .write-body {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .write-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .write-textarea {
            flex: 1;
            resize: none;
            min-height: 120px;
        }

        .write-footer {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .write-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .write-btn.cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .write-btn.submit {
            background: #3b82f6;
            color: white;
        }

        /* í”Œë¡œíŒ… ì‘ì„± ë²„íŠ¼ */
        .floating-write-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #3b82f6;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            z-index: 999;
        }

        /* í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }

        /* í”¼ë“œ í•„í„° ë“œë¡­ë‹¤ìš´ */
        .feed-filter {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
        }

        .filter-dropdown {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-dropdown:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .filter-options {
            position: absolute;
            top: 40px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 120px;
            z-index: 100;
            display: none;
        }

        .filter-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .filter-option:hover {
            background: #f3f4f6;
        }

        /* ì¢‹ì•„ìš” ìƒí˜¸ì‘ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ (ë‰´ìŠ¤í”¼ë“œì™€ ë™ì¼í•˜ê²Œ) */
        .like-action:hover {
            color: #ef4444 !important;
        }

        .like-action.liked {
            color: #ef4444 !important;
        }

        .like-action.liked svg {
            fill: #ef4444;
        }

        /* ëŒ“ê¸€/ì¢‹ì•„ìš” ì•¡ì…˜ í˜¸ë²„ íš¨ê³¼ í†µì¼ */
        .post-actions .action:hover {
            background-color: #f3f4f6;
            color: #007aff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }

        /* ì¢‹ì•„ìš” ì•¡ì…˜ë§Œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ */
        .post-actions .like-action:hover {
            color: #ef4444 !important;
        }


        .post-actions .like-action:hover::after {
            background-color: #ef4444;
        }

        @keyframes expandWidth {
            to { width: 80%; }
        }

        /* SVG í˜¸ë²„ ì• ë‹ˆë©”ì´ì…˜ */
        .post-actions .action svg {
            transition: transform 0.3s ease;
        }

        .post-actions .action:hover svg {
            transform: scale(1.2);
        }

        #imageModal {
            z-index: 2000; /* ë‹¤ë¥¸ ëª¨ë‹¬ë³´ë‹¤ ìœ„ì— */
        }

        #imageModal img {
            transition: transform 0.3s ease;
        }

        #imageModal button:hover {
            background: rgba(255,255,255,0.4) !important;
        }

        /* ê²Œì‹œë¬¼ ì´ë¯¸ì§€ì— í˜¸ë²„ íš¨ê³¼ ì¶”ê°€ */
        .post-image {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .post-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

<div class="sidebar">
    <h1>PicFlow</h1>
    <div class="menu-wrapper">
        <div class="menu-item" onclick="goTo('newsfeed.html')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
            í™ˆ
        </div>
        <div class="menu-item" onclick="goTo('search.html')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
            ê²€ìƒ‰
        </div>
        <div class="menu-item" onclick="openModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            ë§Œë“¤ê¸°
        </div>
        <div class="menu-item" onclick="goTo('mypage.html')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            í”„ë¡œí•„
        </div>
    </div>
</div>

<div class="profile-card" id="userProfile">
    <div class="profile-wrapper">
        <div class="name-wrapper">
            <h2 class="userName" id="userName"></h2>
            <p id="user-info"></p>
        </div>
        <img id="userImage" src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
    </div>
    <p href="#" id="userBio"></p>
    <a id = "follower-count"> íŒ”ë¡œì›Œ = 0 </a>
    <div class="button-container">
        <button class="edit-profile-btn" onclick="openEditModal()">í”„ë¡œí•„ ìˆ˜ì •</button>
    </div>
    <div class="text-title-container">
        <h2>ê²Œì‹œë¬¼</h2>
    </div>
    <hr style="border: none; border-top: 1px solid #b8b6b6; margin-top: 12px" />

    <div id="post-list"></div>
</div>




<script>

    // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
    let existingImages = []; // ê¸°ì¡´ ì´ë¯¸ì§€ ê´€ë¦¬ìš©
    let imagesToDelete = []; // ì‚­ì œí•  ì´ë¯¸ì§€ IDë“¤
    const baseUrl = "http://localhost:8080";
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");

    let currentImages = [];
    let currentImageIndex = 0;

    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function getCurrentUser() {
        try {
            const res = await fetch(`${baseUrl}/api/users/${userId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (res.ok) {
                currentUser = await res.json();
            }
        } catch (err) {
            console.error("í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", err);
        }
    }

    // ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadUserProfile() {
        try {
            const res = await fetch(`${baseUrl}/api/users/${userId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            const user = await res.json();

            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
            const userImage = document.getElementById("userImage");
            userImage.src = user.profileImage
                ? `${baseUrl}/images/${user.profileImage}`
                : "https://via.placeholder.com/100x100?text=No+Img";
            userImage.onerror = () => {
                userImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIOq3uOudvOuUlOyWuO2KuCDsoJXsnZggLS0+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJwZXJzb25HcmFkaWVudCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmZmZmY7c3RvcC1vcGFjaXR5OjAuOSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmZmZmO3N0b3Atb3BhY2l0eTowLjciIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIOybkO2YhSDrsLDqsr0gKOq3uOudvOuUlOyWuO2KuCkgLS0+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9InVybCgjYmdHcmFkaWVudCkiLz4KICA8IS0tIOyCrOumhCDsi6TroKjsmIvsnIQgKOuNlCDshLjroKjrkJzsmYQg65SU7J6Q7J2EKSAtLT4KICA8IS0tIOuquOumrCAtLT4KICA8Y2lyY2xlIGN4PSIyMCIgY3k9IjE0IiByPSI3IiBmaWxsPSJ1cmwoI3BlcnNvbkdyYWRpZW50KSIvPgogIDwhLS0g66qJ7YG1ICjrjZQg7J6Q7Jew7Iqk7Yuw7JuQIOqzoOyEoCkgLS0+CiAgPHBhdGggZD0iTTYgMzYgQzYgMjcsIDEyIDIzLCAyMCAyMyBDMjggMjMsIDM0IDI3LCAzNCAzNiBDMzQgMzgsIDM0IDQwLCAzNCA0MCBMOSA0MCBDOCA0MCwgNiAzOCwgNiAzNiBaIiBmaWxsPSJ1cmwoI3BlcnNvbkdyYWRpZW50KSIvPgo8L3N2Zz4K";
            };

            // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            document.getElementById("userName").textContent = user.username || "ì‚¬ìš©ìëª… ì—†ìŒ";
            document.getElementById("user-info").textContent = user.email || "ì´ë©”ì¼ ì—†ìŒ";
            document.getElementById("userBio").textContent = user.bio || "(ì†Œê°œ ì—†ìŒ)";

            // íŒ”ë¡œì›Œ ìˆ˜ ì„¤ì •
            const followerCount = user.followerCount || 0;
            document.getElementById("follower-count").textContent = `íŒ”ë¡œì›Œ ${followerCount}ëª…`;


        } catch (err) {
            console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", err);
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
        }
    }


    // í˜ì´ì§€ ì´ë™
    function goTo(path) {
        window.location.href = `/${path}`;
    }

    // ì‚¬ìš©ìë³„ ê²Œì‹œë¬¼ ë¡œë“œ
    async function loadUserPosts() {
        try {
            // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
            const timestamp = new Date().getTime();
            const res = await fetch(`${baseUrl}/api/posts/user/${userId}?page=0&size=10&_t=${timestamp}`, {
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Cache-Control": "no-cache, no-store, must-revalidate",
                    "Pragma": "no-cache",
                    "Expires": "0"
                }
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            const data = await res.json();
            const feed = document.getElementById("post-list");
            feed.innerHTML = "";

            if (!data.posts || data.posts.length === 0) {
                feed.innerHTML = "<p style='text-align: center; color: #6b7280; padding: 20px;'>ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.posts.forEach(post => {
                const postElement = createPostElement(post);
                feed.appendChild(postElement);
            });

        } catch (err) {
            console.error("ì‚¬ìš©ì ê²Œì‹œë¬¼ ë¡œë”© ì‹¤íŒ¨:", err);
            const feed = document.getElementById("post-list");
            feed.innerHTML = "<p style='text-align: center; color: #ef4444; padding: 20px;'>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        }
    }

    // ì„œë¸Œë©”ë‰´
    function toggleSubmenu(submenuId) {
        const element = document.getElementById(submenuId);
        if (element) {  // null ì²´í¬ ì¶”ê°€
            element.style.display = element.style.display === 'block' ? 'none' : 'block';
        } else {
            console.warn(`Element with id '${submenuId}' not found`);
        }
    }

    // ê²Œì‹œë¬¼ ìš”ì†Œ ìƒì„±
    // ìˆ˜ì •ëœ createPostElement í•¨ìˆ˜
    function createPostElement(post) {
        const postElement = document.createElement("div");
        postElement.className = "post";
        postElement.style.cssText = `
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        background: white;
        transition: all 0.3s ease;
    `;

        // ì´ë¯¸ì§€ ë°°ì—´ ì¤€ë¹„ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
        const imageUrls = post.images ? post.images.map(img => `${baseUrl}/images/${img.imageUrl}`) : [];

        // JSON.stringify ëŒ€ì‹  ë°ì´í„° ì†ì„± ì‚¬ìš©
        const imagesData = JSON.stringify(post.images || []).replace(/"/g, '&quot;');

        postElement.innerHTML = `
        <div class="author-info" style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
            <img class="author-img"
                 src="${post.authorImageUrl ? `${baseUrl}/images/${post.authorImageUrl}` : 'https://via.placeholder.com/32x32?text=No+Img'}"
                 alt="ì‘ì„±ì ì´ë¯¸ì§€"
                 style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; object-fit: cover;"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIOq3uOudvOuUlOyWuO2KuCDsoJXsnZggLS0+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJwZXJzb25HcmFkaWVudCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmZmZmY7c3RvcC1vcGFjaXR5OjAuOSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmZmZmO3N0b3Atb3BhY2l0eTowLjciIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIOybkO2YhSDrsLDqsr0gKOq3uOudvOuUlOyWuO2KuCkgLS0+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9InVybCgjYmdHcmFkaWVudCkiLz4KICA8IS0tIOyCrOumhCDsi6TroKjsmIvsnIQgKOuNlCDshLjroKjrkJzsmYQg65SU7J6Q7J2EKSAtLT4KICA8IS0tIOuquOumrCAtLT4KICA8Y2lyY2xlIGN4PSIyMCIgY3k9IjE0IiByPSI3IiBmaWxsPSJ1cmwoI3BlcnNvbkdyYWRpZW50KSIvPgogIDwhLS0g66qJ7YG1ICjrjZQg7J6Q7Jew7Iqk7Yuw7JuQIOqzoOyEoCkgLS0+CiAgPHBhdGggZD0iTTYgMzYgQzYgMjcsIDEyIDIzLCAyMCAyMyBDMjggMjMsIDM0IDI3LCAzNCAzNiBDMzQgMzgsIDM0IDQwLCAzNCA0MCBMOSA0MCBDOCA0MCwgNiAzOCwgNiAzNiBaIiBmaWxsPSJ1cmwoI3BlcnNvbkdyYWRpZW50KSIvPgo8L3N2Zz4K'" />
            <strong style="font-weight: 600; color: #374151;">${post.author || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì'}</strong>
            <span style="color: #6b7280; font-size: 14px; margin-left: 8px;">${formatDate(post.createdAt)}</span>

            <div class="post-menu" style="margin-left: auto; position: relative;">
                <button class="menu-btn" onclick="togglePostMenu(${post.id})" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #6b7280; padding: 8px; border-radius: 50%;">
                    â‹¯
                </button>
                <div id="post-menu-${post.id}" class="menu-dropdown" style="display: none; position: absolute; right: 0; top: 35px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 120px;">
                    <button onclick="openEditPostModalSafe(${post.id}); hidePostMenu(${post.id})"
                            data-title="${(post.title || '').replace(/"/g, '&quot;')}"
                            data-content="${(post.content || '').replace(/"/g, '&quot;')}"
                            data-images="${imagesData}"
                            style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; border-bottom: 1px solid #f3f4f6;"
                            onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='none'">
                        ìˆ˜ì •
                    </button>
                    <button onclick="deletePost(${post.id}); hidePostMenu(${post.id})"
                            style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; color: #ef4444;"
                            onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>

        <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #1f2937;">${post.title || 'ì œëª© ì—†ìŒ'}</h3>
        <p style="margin: 0 0 12px 0; line-height: 1.5; color: #374151;">${post.content || ''}</p>

        ${post.images && post.images.length > 0 ? `
            <div class="post-images" style="margin: 12px 0;">
                ${post.images.map((imageObj, index) => {
            const imageUrl = `${baseUrl}/images/${imageObj.imageUrl}`;
            return `<img class="post-image"
                                 src="${imageUrl}"
                                 alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€"
                                 style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; margin: 5px 0; cursor: pointer; transition: transform 0.3s ease;"
                                 onclick="openImageModal('${imageUrl}', ${JSON.stringify(imageUrls).replace(/"/g, '&quot;')}, ${index})"
                                 onmouseover="this.style.transform='scale(1.02)'"
                                 onmouseout="this.style.transform='scale(1)'"
                                 onerror="this.style.display='none'" />`;
        }).join('')}
            </div>
        ` : ""}

        <div class="post-actions" style="display: flex; gap: 16px; align-items: center; padding-top: 12px; border-top: 1px solid #f3f4f6;">
            <span class="action like-action" onclick="toggleLike(${post.id}, this)" style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #6b7280; transition: color 0.3s ease;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
                    <path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 1 0-7.8 7.8l1 1L12 21l7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"/>
                </svg>
                <span id="like-count-${post.id}">0</span>
            </span>
            <span class="action" style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #6b7280; transition: color 0.3s ease;"
                  onclick="toggleComments(${post.id})"
                  onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#6b7280'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 1 1 17 0z"/>
                </svg>
                <span id="comment-count-${post.id}">0</span>
            </span>
        </div>

        <div id="comment-section-${post.id}" class="comment-section" style="display:none; margin-top:16px; padding-top:16px; border-top: 1px solid #f3f4f6;">
            <div id="comment-list-${post.id}" style="margin-bottom:12px;"></div>
            <div class="comment-form" style="display: flex; gap: 8px;">
                <textarea id="comment-input-${post.id}"
                         placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                         style="flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; resize: vertical; min-height: 36px; font-family: inherit;"></textarea>
                <button onclick="submitComment(${post.id})"
                        style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s ease;"
                        onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">ì‘ì„±</button>
            </div>
        </div>
    `;

        // ëŒ“ê¸€ ìˆ˜ì™€ ì¢‹ì•„ìš” ìˆ˜ ë¡œë“œ
        loadCommentCount(post.id);
        loadLikeCount(post.id);
        loadUserLikeStatus(post.id);

        return postElement;
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
        if (!dateString) return '';

        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
            if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
            if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
            if (diffDays < 7) return `${diffDays}ì¼ ì „`;

            return date.toLocaleDateString('ko-KR');
        } catch (err) {
            return '';
        }
    }

    // ëŒ“ê¸€ í† ê¸€
    function toggleComments(postId) {
        const section = document.getElementById(`comment-section-${postId}`);
        if (section.style.display === 'none') {
            section.style.display = 'block';
            loadComments(postId);
        } else {
            section.style.display = 'none';
        }
    }

    async function submitPost() {
        const title = document.getElementById('postTitle').value.trim();
        const content = document.getElementById('postContent').value.trim();
        const imageFiles = Array.from(document.getElementById('imageUpload').files);

        if (!title || !content) {
            alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            let imageIds = []; // Long ë°°ì—´

            if (imageFiles.length > 0) {
                for (const file of imageFiles) {
                    const imageId = await uploadImage(file);
                    console.log("ğŸ“¤ ë°›ì€ imageId:", imageId, typeof imageId);

                    if (imageId && !isNaN(imageId)) {
                        imageIds.push(parseInt(imageId));
                    }
                }
            }

            const payload = {
                title,
                content,
                imageIds: imageIds // Long[] íƒ€ì…
            };

            console.log("ğŸ“¤ ì „ì†¡í•  payload:", payload);

            const res = await fetch(`${baseUrl}/api/posts`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("ê²Œì‹œë¬¼ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeModal();
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('imageUpload').value = '';
                await loadUserPosts();
            } else {
                const errorText = await res.text();
                console.error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", errorText);
                throw new Error(`ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨: ${res.status} - ${errorText}`);
            }
        } catch (err) {
            console.error("ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨:", err);
            alert("ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨: " + err.message);
        }
    }



    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments(postId) {
        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}/comments`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            const commentList = document.getElementById(`comment-list-${postId}`);

            if (!data.content || data.content.length === 0) {
                commentList.innerHTML = "<p style='color: #6b7280; font-size: 14px; text-align: center; padding: 12px;'>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            } else {
                const commentsHtml = data.content.map(comment => `
                <div class="comment-item" style="padding: 8px 0; border-bottom: 1px solid #f3f4f6; last-child: border-bottom: none;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <strong style="font-size: 14px; color: #374151;">${comment.name || 'ìµëª…'}</strong>
                        <span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">${formatDate(comment.createdAt)}</span>
                    </div>
                    <p style="margin: 0; font-size: 14px; line-height: 1.4; color: #4b5563;">${comment.content || ''}</p>
                </div>
            `).join("");
                commentList.innerHTML = commentsHtml;
            }

            // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
            const countEl = document.getElementById(`comment-count-${postId}`);
            if (countEl) {
                countEl.textContent = data.content.length;
            }

        } catch (err) {
            console.error("ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨:", err);
            const commentList = document.getElementById(`comment-list-${postId}`);
            commentList.innerHTML = "<p style='color: #ef4444; font-size: 14px; text-align: center; padding: 12px;'>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    // ì¢‹ì•„ìš” ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadLikeCount(postId) {
        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}/likes/count`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const count = await res.json();
                const countEl = document.querySelector(`#like-count-${postId}`);
                if (countEl) {
                    countEl.textContent = count;
                }
            }
        } catch (err) {
            console.error(`ì¢‹ì•„ìš” ìˆ˜ ë¡œë”© ì‹¤íŒ¨ (${postId}):`, err);
        }
    }

    // ëŒ“ê¸€ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCommentCount(postId) {
        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}/comments`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const data = await res.json();
                const countEl = document.getElementById(`comment-count-${postId}`);
                if (countEl) {
                    countEl.textContent = data.content ? data.content.length : 0;
                }
            }
        } catch (err) {
            console.error(`ëŒ“ê¸€ ìˆ˜ ë¡œë”© ì‹¤íŒ¨ (${postId}):`, err);
        }
    }

    // ëŒ“ê¸€ ì‘ì„±
    async function submitComment(postId) {
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();

        if (!content) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}/comments`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ content: content })
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            input.value = "";
            loadComments(postId);
            alert("ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (err) {
            console.error("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:", err);
            alert("ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
        }
    }

    // ëª¨ë‹¬ ì—´ê¸° (ê²Œì‹œë¬¼ ì‘ì„±)
    function openModal() {
        // ê²Œì‹œë¬¼ ì‘ì„± ëª¨ë‹¬ êµ¬í˜„
        alert("ê²Œì‹œë¬¼ ì‘ì„± ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    function togglePostMenu(postId) {
        const menu = document.getElementById(`post-menu-${postId}`);
        const isVisible = menu.style.display === 'block';

        // ë‹¤ë¥¸ ëª¨ë“  ë©”ë‰´ ë‹«ê¸°
        document.querySelectorAll('.menu-dropdown').forEach(m => m.style.display = 'none');

        // í˜„ì¬ ë©”ë‰´ í† ê¸€
        menu.style.display = isVisible ? 'none' : 'block';
    }

    function hidePostMenu(postId) {
        document.getElementById(`post-menu-${postId}`).style.display = 'none';
    }

    async function deletePost(postId) {
        if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (res.ok) {
                alert('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadUserPosts();
            } else {
                throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (err) {
            alert('ê²Œì‹œë¬¼ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
        }
    }


    // ë¬¸ì„œ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.menu-dropdown').forEach(m => m.style.display = 'none');
        }
    });

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function initializePage() {
        // í† í° í™•ì¸
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/login.html";
            return;
        }

        // userId í™•ì¸
        if (!userId) {
            alert("ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/";
            return;
        }

        try {
            // ìˆœì°¨ì ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
            await getCurrentUser();
            await loadUserProfile();
            await loadUserPosts();

            console.log("í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ");

        } catch (err) {
            console.error("í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
            alert("í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function openEditModal() {
        // í˜„ì¬ ì •ë³´ë¡œ í¼ ì±„ìš°ê¸° (bioê°€ "(ì†Œê°œ ì—†ìŒ)"ì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ)
        document.getElementById('editUsername').value = document.getElementById('userName').textContent;

        const currentBio = document.getElementById('userBio').textContent;
        document.getElementById('editBio').value = currentBio === '(ì†Œê°œ ì—†ìŒ)' ? '' : currentBio;

        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('editProfileImage').value = '';

        document.getElementById('editProfileModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editProfileModal').style.display = 'none';
    }

    async function saveProfile() {
        const username = document.getElementById('editUsername').value.trim();
        const bio = document.getElementById('editBio').value.trim();
        const fileInput = document.getElementById('editProfileImage');

        if (!username) {
            alert('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            let profileImageFileName = '';

            // ì´ë¯¸ì§€ íŒŒì¼ì´ ì„ íƒëœ ê²½ìš° ë¨¼ì € ì—…ë¡œë“œ
            if (fileInput.files[0]) {
                try {
                    profileImageFileName = await uploadImage(fileInput.files[0]);
                    if (!profileImageFileName) {
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                } catch (err) {
                    console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—ëŸ¬:", err);
                    alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message);
                    return;
                }
            }

            // í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ìš”ì²­
            const payload = {
                username: username,
                bio: bio
            };

            // ìƒˆ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œëœ ê²½ìš°ì—ë§Œ profileImage ì¶”ê°€
            if (profileImageFileName) {
                payload.profileImage = profileImageFileName;
            }

            const res = await fetch(`${baseUrl}/api/users/profile`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
                await loadUserProfile();
            } else {
                const errorText = await res.text();
                throw new Error(`HTTP ${res.status}: ${errorText}`);
            }

        } catch (err) {
            console.error('í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨:', err);
            alert('í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
        }
    }
    let editingPostId = null;

    // ìˆ˜ì •ëœ openEditPostModalSafe í•¨ìˆ˜
    function openEditPostModalSafe(postId) {
        const button = event.currentTarget;
        const title = button.getAttribute('data-title').replace(/&quot;/g, '"');
        const content = button.getAttribute('data-content').replace(/&quot;/g, '"');
        const images = JSON.parse(button.getAttribute('data-images').replace(/&quot;/g, '"'));

        openEditPostModal(postId, title, content, images);
    }

    // ìˆ˜ì •ëœ openEditPostModal í•¨ìˆ˜
    function openEditPostModal(postId, title, content, images) {
        console.log("ğŸ”§ ìˆ˜ì • ëª¨ë‹¬ ì—´ë¦¼:", postId, title, content, images);

        editingPostId = postId;
        existingImages = [...(images || [])]; // ê¸°ì¡´ ì´ë¯¸ì§€ ë³µì‚¬
        imagesToDelete = []; // ì‚­ì œí•  ì´ë¯¸ì§€ ëª©ë¡ ì´ˆê¸°í™”

        // ì•ˆì „í•˜ê²Œ ìš”ì†Œ ì°¾ê¸°
        const titleInput = document.getElementById('editPostTitle');
        const contentInput = document.getElementById('editPostContent');
        const imageInput = document.getElementById('editPostImage');

        if (!titleInput || !contentInput || !imageInput) {
            console.error("ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            alert("ìˆ˜ì • ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            return;
        }

        titleInput.value = title || '';
        contentInput.value = content || '';
        imageInput.value = '';

        renderExistingImages();
        document.getElementById('editPostModal').style.display = 'flex';
    }

    // ìˆ˜ì •ëœ closeEditPostModal í•¨ìˆ˜
    function closeEditPostModal() {
        document.getElementById('editPostModal').style.display = 'none';
        editingPostId = null;
        existingImages = [];
        imagesToDelete = [];
    }

    // ìˆ˜ì •ëœ updatePost í•¨ìˆ˜
    async function updatePost() {
        const titleInput = document.getElementById('editPostTitle');
        const contentInput = document.getElementById('editPostContent');
        const imageInput = document.getElementById('editPostImage');

        if (!titleInput || !contentInput || !imageInput) {
            alert('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }

        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        const imageFiles = Array.from(imageInput.files);

        if (!title || !content) {
            alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            // 1. ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ
            let newImageIds = [];
            if (imageFiles.length > 0) {
                for (const file of imageFiles) {
                    try {
                        const imageId = await uploadImage(file);
                        console.log("ğŸ“¤ ë°›ì€ imageId:", imageId, typeof imageId);

                        if (imageId && !isNaN(imageId)) {
                            newImageIds.push(parseInt(imageId));
                        } else {
                            console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ imageId:", imageId);
                        }
                    } catch (err) {
                        console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message);
                        return;
                    }
                }
            }

            // 2. ì‚­ì œí•  ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì‚­ì œ
            if (imagesToDelete.length > 0) {
                for (const imageId of imagesToDelete) {
                    try {
                        await fetch(`${baseUrl}/api/images/${imageId}`, {
                            method: 'DELETE',
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        console.log(`ğŸ—‘ï¸ ì´ë¯¸ì§€ ${imageId} ì‚­ì œ ì™„ë£Œ`);
                    } catch (err) {
                        console.error(`âŒ ì´ë¯¸ì§€ ${imageId} ì‚­ì œ ì‹¤íŒ¨:`, err);
                    }
                }
            }

            // 3. ê²Œì‹œë¬¼ ì—…ë°ì´íŠ¸
            const payload = {
                title,
                content,
                imageIds: [
                    ...existingImages.map(img => img.imageId), // ìœ ì§€í•  ê¸°ì¡´ ì´ë¯¸ì§€
                    ...newImageIds // ìƒˆë¡œ ì¶”ê°€í•  ì´ë¯¸ì§€
                ]
            };

            console.log("ğŸ“¤ ì—…ë°ì´íŠ¸ payload:", payload);

            const res = await fetch(`${baseUrl}/api/posts/${editingPostId}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('ê²Œì‹œë¬¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditPostModal();
                await loadUserPosts(); // ê²Œì‹œë¬¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                const errorText = await res.text();
                console.error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", errorText);
                throw new Error(`ìˆ˜ì • ì‹¤íŒ¨: ${res.status} - ${errorText}`);
            }

        } catch (err) {
            console.error('âŒ ê²Œì‹œë¬¼ ìˆ˜ì • ì‹¤íŒ¨:', err);
            alert('ê²Œì‹œë¬¼ ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
        }
    }

    // openModal í•¨ìˆ˜ ìˆ˜ì •
    function openModal() {
        document.getElementById("overlay").style.display = "flex";
    }

    // closeModal í•¨ìˆ˜ ì¶”ê°€
    function closeModal() {
        document.getElementById("overlay").style.display = "none";
    }

    // ìˆ˜ì •ëœ submitQuickPost í•¨ìˆ˜
    async function submitQuickPost() {
        const title = document.getElementById('quick-title').value.trim();
        const content = document.getElementById('quick-content').value.trim();
        const imageFiles = Array.from(document.getElementById('quick-image').files);

        if (!title || !content) {
            alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            let imageIds = []; // Long ë°°ì—´

            if (imageFiles.length > 0) {
                for (const file of imageFiles) {
                    try {
                        const imageId = await uploadImage(file);
                        console.log("ğŸ“¤ ë°›ì€ imageId:", imageId, typeof imageId);

                        if (imageId && !isNaN(imageId)) {
                            imageIds.push(parseInt(imageId));
                        }
                    } catch (err) {
                        console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message);
                        return;
                    }
                }
            }

            const payload = {
                title,
                content,
                imageIds: imageIds // Long[] íƒ€ì…
            };

            console.log("ğŸ“¤ ì „ì†¡í•  payload:", payload);

            const res = await fetch(`${baseUrl}/api/posts`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                console.error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", errorText);
                throw new Error(`ê²Œì‹œë¬¼ ë“±ë¡ ì‹¤íŒ¨: ${res.status} - ${errorText}`);
            }

            alert("âœ… ê²Œì‹œë¬¼ ì‘ì„± ì™„ë£Œ!");
            closeWritePanel();
            await loadUserPosts();

        } catch (err) {
            console.error("âŒ ê²Œì‹œ ì‹¤íŒ¨:", err);
            alert("ê²Œì‹œ ì‹¤íŒ¨: " + err.message);
        }
    }

    function renderExistingImages() {
        const existingImagesDiv = document.getElementById('existingImages');

        if (existingImages && existingImages.length > 0) {
            existingImagesDiv.innerHTML = `
            <label style="font-weight: 500; margin-bottom: 8px; display: block;">ê¸°ì¡´ ì´ë¯¸ì§€:</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${existingImages.map((img, index) => `
                    <div style="position: relative; display: inline-block;">
                        <img src="${baseUrl}/images/${img.imageUrl}"
                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px;">
                        <button type="button" onclick="removeExistingImage(${index})"
                                style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
                                       background: #ef4444; color: white; border: none; border-radius: 50%;
                                       cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                `).join('')}
            </div>
            ${imagesToDelete.length > 0 ? `
                <div style="margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 6px; font-size: 12px; color: #dc2626;">
                    ì‚­ì œ ì˜ˆì •: ${imagesToDelete.length}ê°œ ì´ë¯¸ì§€
                </div>
            ` : ''}
        `;
        } else {
            existingImagesDiv.innerHTML = '';
        }
    }

    // ì‘ì„± íŒ¨ë„ í† ê¸€
    function toggleWritePanel() {
        const panel = document.getElementById('write-panel');
        panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }

    // ì‘ì„± íŒ¨ë„ ë‹«ê¸°
    function closeWritePanel() {
        document.getElementById('write-panel').style.display = 'none';
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('quick-title').value = '';
        document.getElementById('quick-content').value = '';
        document.getElementById('quick-image').value = '';
    }

    // ë¹ ë¥¸ ê²Œì‹œë¬¼ ì‘ì„±
    // í•„í„° ë“œë¡­ë‹¤ìš´ í† ê¸€
    function toggleFilterDropdown() {
        const options = document.getElementById('filter-options');
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    }

    // í•„í„° ì„¤ì •
    function setFilter(filterType) {
        document.getElementById('current-filter').textContent = filterType;
        document.getElementById('filter-options').style.display = 'none';

        // ì—¬ê¸°ì— í•„í„°ë§ ë¡œì§ ì¶”ê°€
        switch(filterType) {
            case 'ì¶”ì²œ':
                // ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ê²Œì‹œë¬¼ ì •ë ¬
                break;
            case 'íŒ”ë¡œì‰':
                // íŒ”ë¡œì‰í•œ ì‚¬ìš©ì ê²Œì‹œë¬¼ë§Œ í‘œì‹œ
                break;
            case 'ìµœì‹ ':
                // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                break;
        }
        loadUserPosts(); // ê¸°ì¡´ í•¨ìˆ˜ ì¬í˜¸ì¶œ
    }

    // ë¬¸ì„œ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸° (ê¸°ì¡´ document.addEventListener ì•ˆì— ì¶”ê°€)
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            document.getElementById('filter-options').style.display = 'none';
        }
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.menu-dropdown').forEach(m => m.style.display = 'none');
        }
    });

    // ë©”ì¸ ë©”ë‰´ í† ê¸€
    function toggleMainMenu() {
        const menu = document.getElementById('main-menu');
        if (menu) {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        } else {
            console.warn("main-menu ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    document.addEventListener('click', function(e) {
        // í–„ë²„ê±° ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        if (!e.target.closest('.hamburger-menu') && !e.target.closest('.menu-options')) {
            const mainMenu = document.getElementById('main-menu');
            if (mainMenu) {
                mainMenu.style.display = 'none';
            }
        }

        // í•„í„° ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        if (!e.target.closest('.filter-dropdown')) {
            const filterOptions = document.getElementById('filter-options');
            if (filterOptions) {
                filterOptions.style.display = 'none';
            }
        }

        // ê²Œì‹œë¬¼ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.menu-dropdown').forEach(m => m.style.display = 'none');
        }
    });

    // ìˆ˜ì •ëœ removeExistingImage í•¨ìˆ˜
    function removeExistingImage(index) {
        if (confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const removedImage = existingImages[index];

            // ì‚­ì œí•  ì´ë¯¸ì§€ ëª©ë¡ì— ì¶”ê°€
            if (removedImage.imageId) {
                imagesToDelete.push(removedImage.imageId);
            }

            // ê¸°ì¡´ ì´ë¯¸ì§€ ëª©ë¡ì—ì„œ ì œê±°
            existingImages.splice(index, 1);

            // í™”ë©´ ë‹¤ì‹œ ë Œë”ë§
            renderExistingImages();

            console.log("ğŸ—‘ï¸ ì‚­ì œ ì˜ˆì • ì´ë¯¸ì§€:", imagesToDelete);
            console.log("ğŸ–¼ï¸ ë‚¨ì€ ê¸°ì¡´ ì´ë¯¸ì§€:", existingImages);
        }
    }

    // ì„œë¸Œë©”ë‰´ í‘œì‹œ
    function showSubmenu(submenuId) {
        document.getElementById(submenuId).style.display = 'block';
    }

    // ì„œë¸Œë©”ë‰´ ìˆ¨ê¸°ê¸°
    function hideSubmenu(submenuId) {
        document.getElementById(submenuId).style.display = 'none';
    }

    // í…Œë§ˆ ì„¤ì •
    function setTheme(theme) {
        if (theme === 'dark') {
            document.body.style.background = '#1f2937';
            document.body.style.color = 'white';
            // ë‹¤í¬ í…Œë§ˆ ì ìš© ë¡œì§
        } else {
            document.body.style.background = '#f9fafb';
            document.body.style.color = 'black';
            // ë¼ì´íŠ¸ í…Œë§ˆ ì ìš© ë¡œì§
        }
        toggleMainMenu(); // ë©”ë‰´ ë‹«ê¸°
        alert(`${theme} í…Œë§ˆë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // í”¼ë“œ íƒ€ì… ì„¤ì •
    function setFeedType(type) {
        // ê¸°ì¡´ setFilter í•¨ìˆ˜ í™œìš©
        setFilter(type);
        toggleMainMenu(); // ë©”ë‰´ ë‹«ê¸°
    }

    // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ ìˆ˜ì •
    function logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // ëª¨ë“  localStorage ë°ì´í„° ì œê±°
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.clear(); // ëª¨ë“  ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬

            // í˜ì´ì§€ ìºì‹œë„ ì •ë¦¬
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }

            // ê°•ì œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í˜ì´ì§€ ì´ë™
            window.location.replace('/login.html');
        }
    }

    // ë¬¸ì„œ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° (ê¸°ì¡´ addEventListenerì— ì¶”ê°€)
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.hamburger-menu') && !e.target.closest('.menu-options')) {
            document.getElementById('main-menu').style.display = 'none';
        }
        // ê¸°ì¡´ ì½”ë“œë“¤...
    });

    // ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
    async function toggleLike(postId, likeElement) {
        try {
            const countSpan = likeElement.querySelector('span');
            const currentCount = parseInt(countSpan.textContent) || 0;
            const isLiked = likeElement.classList.contains('liked');

            if (isLiked) {
                // ì¢‹ì•„ìš” ì·¨ì†Œ
                const res = await fetch(`${baseUrl}/api/posts/${postId}/likes`, {
                    method: 'DELETE',
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.ok) {
                    likeElement.classList.remove('liked');
                    countSpan.textContent = currentCount - 1;
                    likeElement.style.color = '#6b7280';
                }
            } else {
                // ì¢‹ì•„ìš” ì¶”ê°€
                const res = await fetch(`${baseUrl}/api/posts/${postId}/likes`, {
                    method: 'POST',
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.ok) {
                    likeElement.classList.add('liked');
                    countSpan.textContent = currentCount + 1;
                    likeElement.style.color = '#ef4444';
                }
            }
        } catch (err) {
            console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', err);
            alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì‚¬ìš©ìì˜ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ í•¨ìˆ˜
    async function loadUserLikeStatus(postId) {
        try {
            const res = await fetch(`${baseUrl}/api/posts/${postId}/likes`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const likeUserList = await res.json();
                const likeElement = document.querySelector(`#like-count-${postId}`).parentElement;

                // í˜„ì¬ ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” ëˆ„ë¥¸ ì‚¬ëŒ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
                const userLiked = likeUserList.some(like => like.userId == userId);

                if (userLiked) {
                    likeElement.classList.add('liked');
                    likeElement.style.color = '#ef4444';
                } else {
                    likeElement.classList.remove('liked');
                    likeElement.style.color = '#6b7280';
                }
            }
        } catch (err) {
            console.error(`ì¢‹ì•„ìš” ìƒíƒœ ë¡œë”© ì‹¤íŒ¨ (${postId}):`, err);
        }
    }


    // 1. uploadImage í•¨ìˆ˜ ìˆ˜ì • - imageId ë°˜í™˜í•˜ë„ë¡
    async function uploadImage(file) {
        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch(`${baseUrl}/api/image/upload`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });

        if (!res.ok) {
            throw new Error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${res.status}`);
        }

        try {
            const data = await res.json();
            console.log("ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‘ë‹µ:", data);

            // imageIdë¥¼ ìš°ì„ ìœ¼ë¡œ ë°˜í™˜ (Long íƒ€ì…)
            return data.imageId || data.id;
        } catch {
            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ì—ì„œ ID ì¶”ì¶œ ì‹œë„
            const text = await res.text();
            console.log("ğŸ“¤ í…ìŠ¤íŠ¸ ì‘ë‹µ:", text);

            // ìˆ«ì ID ì¶”ì¶œ ì‹œë„
            const idMatch = text.match(/imageId[":=\s]+(\d+)/i) || text.match(/id[":=\s]+(\d+)/i);
            if (idMatch) {
                return parseInt(idMatch[1]);
            }

            throw new Error("ì´ë¯¸ì§€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }
    }

    function openImageModal(imageSrc, allImages = [], startIndex = 0) {
        currentImages = allImages.length > 0 ? allImages : [imageSrc];
        currentImageIndex = startIndex;

        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('imageModal').style.display = 'flex';
        updateImageCounter();
        updateNavigationButtons();

        // ESC í‚¤ë¡œ ë‹«ê¸°
        document.addEventListener('keydown', handleImageModalKeydown);
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
        document.removeEventListener('keydown', handleImageModalKeydown);
    }

    // ì´ì „ ì´ë¯¸ì§€
    function showPrevImage() {
        if (currentImages.length > 1) {
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            document.getElementById('modalImage').src = currentImages[currentImageIndex];
            updateImageCounter();
        }
    }

    // ë‹¤ìŒ ì´ë¯¸ì§€
    function showNextImage() {
        if (currentImages.length > 1) {
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            document.getElementById('modalImage').src = currentImages[currentImageIndex];
            updateImageCounter();
        }
    }

    // ì´ë¯¸ì§€ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
    function updateImageCounter() {
        document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
    }

    // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');

        if (currentImages.length <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
        }
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleImageModalKeydown(e) {
        switch(e.key) {
            case 'Escape':
                closeImageModal();
                break;
            case 'ArrowLeft':
                showPrevImage();
                break;
            case 'ArrowRight':
                showNextImage();
                break;
        }
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (e.target.id === 'imageModal') {
            closeImageModal();
        }
    });

    // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", initializePage);
</script>

<div id="editProfileModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”„ë¡œí•„ ìˆ˜ì •</h3>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>í”„ë¡œí•„ ì´ë¯¸ì§€</label>
                <input type="file" id="editProfileImage" accept="image/*">
            </div>
            <div class="form-group">
                <label>ì‚¬ìš©ìëª…</label>
                <input type="text" id="editUsername" placeholder="ì‚¬ìš©ìëª…">
            </div>
            <div class="form-group">
                <label>ì†Œê°œ</label>
                <textarea id="editBio" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel-btn" onclick="closeEditModal()">ì·¨ì†Œ</button>
            <button class="save-btn" onclick="saveProfile()">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ê²Œì‹œë¬¼ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editPostModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ê²Œì‹œë¬¼ ìˆ˜ì •</h3>
            <span class="close" onclick="closeEditPostModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
            <div id="existingImages" style="margin-bottom: 16px;"></div>

            <div class="form-group">
                <label>ì œëª©</label>
                <input type="text" id="editPostTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...">
            </div>
            <div class="form-group">
                <label>ë‚´ìš©</label>
                <textarea id="editPostContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 120px;"></textarea>
            </div>
            <div class="form-group">
                <label>ìƒˆ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</label>
                <!-- IDë¥¼ editPostImageë¡œ ìˆ˜ì • -->
                <input type="file" id="editPostImage" accept="image/*" multiple>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel-btn" onclick="closeEditPostModal()">ì·¨ì†Œ</button>
            <button class="save-btn" onclick="updatePost()">ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </div>
</div>



<!-- ê²Œì‹œë¬¼ ì‘ì„± ëª¨ë‹¬ -->
<div id="overlay" class="modal-overlay" style="display:none;">
    <div class="create-modal-content">
        <h3>ê²Œì‹œë¬¼ ì‘ì„±</h3>
        <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="input-field" />
        <textarea id="postContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="input-field" style="height: 100px;"></textarea>
        <input type="file" id="imageUpload" accept="image/*" style="margin-top:10px;" multiple/>

        <div style="margin-top:15px; text-align:right;">
            <button onclick="closeModal()" class="modal-button cancel">ì·¨ì†Œ</button>
            <button onclick="submitPost()" class="modal-button submit" style="margin-left: 10px;">ê²Œì‹œ</button>
        </div>
    </div>
</div>

<!-- ì™¼ìª½ í•˜ë‹¨ í–„ë²„ê±° ë©”ë‰´ -->
<div class="hamburger-menu" onclick="toggleMainMenu()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</div>

<!-- ë©”ë‰´ ì˜µì…˜ íŒ¨ë„ (ID ì¶”ê°€) -->
<div id="main-menu" class="menu-options">
    <div class="menu-item-option has-submenu" onclick="toggleSubmenu('design-submenu')">
        <span>ë””ìì¸</span>
        <div id="design-submenu" class="submenu">
            <div class="submenu-item" onclick="setTheme('light')">ë¼ì´íŠ¸</div>
            <div class="submenu-item" onclick="setTheme('dark')">ë‹¤í¬</div>
        </div>
    </div>

    <div class="menu-item-option has-submenu" onclick="toggleSubmenu('feed-submenu')">
        <span>í”¼ë“œ</span>
        <div id="feed-submenu" class="submenu">
            <div class="submenu-item" onclick="setFeedType('ì¶”ì²œ')">ì¶”ì²œ</div>
            <div class="submenu-item" onclick="setFeedType('íŒ”ë¡œì‰')">íŒ”ë¡œì‰</div>
        </div>
    </div>

    <div class="menu-item-option logout-item" onclick="logout()">
        <span>ë¡œê·¸ì•„ì›ƒ</span>
    </div>
</div>

<!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ í”Œë¡œíŒ… ì‘ì„± ë²„íŠ¼ -->
<button class="floating-write-btn" onclick="toggleWritePanel()">+</button>

<!-- ì‘ì„± íŒ¨ë„ -->
<div id="write-panel" class="write-panel">
    <div class="write-header">
        <span>ìƒˆ ê²Œì‹œë¬¼</span>
        <button onclick="closeWritePanel()" style="background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
    </div>
    <div class="write-body">
        <input type="text" id="quick-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="write-input" multiple>
        <textarea id="quick-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="write-input write-textarea"></textarea>
        <input type="file" id="quick-image" accept="image/*" style="font-size: 14px;">
    </div>
    <div class="write-footer">
        <button class="write-btn cancel" onclick="closeWritePanel()">ì·¨ì†Œ</button>
        <button class="write-btn submit" onclick="submitQuickPost()">ê²Œì‹œ</button>
    </div>
</div>

<div id="imageModal" class="modal" style="display: none; background: rgba(0, 0, 0, 0.9);">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <span onclick="closeImageModal()" style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001;">&times;</span>

        <!-- ì´ì „/ë‹¤ìŒ ë²„íŠ¼ -->
        <button id="prevImageBtn" onclick="showPrevImage()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 30px; padding: 10px 15px; cursor: pointer; border-radius: 5px; z-index: 1001;">â®</button>
        <button id="nextImageBtn" onclick="showNextImage()" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 30px; padding: 10px 15px; cursor: pointer; border-radius: 5px; z-index: 1001;">â¯</button>

        <!-- ì´ë¯¸ì§€ -->
        <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">

        <!-- ì´ë¯¸ì§€ ì •ë³´ -->
        <div id="imageInfo" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; text-align: center; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;">
            <span id="imageCounter">1 / 1</span>
        </div>
    </div>
</div>

</body>
</html>
